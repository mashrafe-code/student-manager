#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void room_check()
{
    FILE *fp;
    char line[555];
    char room[50];
    int period;

    // Ask user input
    printf("Enter period number (1-6): ");
    scanf("%d", &period);
    printf("Enter room name (e.g., C105): ");
    scanf("%s", room);

    // Open routine file
    fp = fopen("routine.txt", "r");
    if (!fp)
    {
        printf("Could not open routine file.\n");
    }

    // Skip header line
    fgets(line, sizeof(line), fp);

    int current = 0, found = 0;
    while (fgets(line, sizeof(line), fp))
    {
        current++;

        // If we are at the requested period
        if (current == period)
        {
            line[strcspn(line, "\n")] = 0; // Remove newline

            // Split using semicolon
            char *time = strtok(line, ";");
            char *am = strtok(NULL, ";");
            char *bm = strtok(NULL, ";");
            char *cm = strtok(NULL, ";");

            // Check if the room exists in this period
            if ((am && strstr(am, room)) || (bm && strstr(bm, room)) || (cm && strstr(cm, room)))
            {
                printf("\nRoom %s is OCCUPIED in period %d.\n", room, period);
                found = 1;
            }
            else
            {
                printf("\nRoom %s is EMPTY in period %d.\n", room, period);
            }
            break;
        }
    }

    fclose(fp);

    // Handle invalid period
    if (current < period)
    {
        printf("\nInvalid period number. No such row in the file.\n");
    }

}

void class_check()
{
    FILE *fp;
    char line[256];
    char section[10];
    int period;

    // Ask user for input
    printf("Enter your section (1AM/1BM/1CM): ");
    scanf("%s", section);
    printf("Enter period number (1-6): ");
    scanf("%d", &period);

    // Open routine file
    fp = fopen("routine.txt", "r");
    if (!fp)
    {
        printf("Could not open routine file.\n");
    }

    // Read header (ignore first line)
    fgets(line, sizeof(line), fp);

    int current = 0;
    while (fgets(line, sizeof(line), fp))
    {
        current++;
        if (current == period)
        {
            // Remove newline
            line[strcspn(line, "\n")] = 0;

            // Split CSV line
            char *token = strtok(line, ";");
            char *time = token;
            char *am = strtok(NULL, ";");
            char *bm = strtok(NULL, ";");
            char *cm = strtok(NULL, ";");

            printf("\nTime: %s\n", time);
            if (strcmp(section, "1AM") == 0)
                printf("Class: %s\n", am);
            else if (strcmp(section, "1BM") == 0)
                printf("Class: %s\n", bm);
            else if (strcmp(section, "1CM") == 0)
                printf("Class: %s\n", cm);
            else
                printf("Invalid section!\n");
            break;
        }
    }

    fclose(fp);
}

int main()
{
    printf("\\\\choose the option\\\\\n\n");

    printf("\\\\1. Student Login...\n");
    printf("\\\\2. Teacher Login...\n");
    printf("\\\\3. Student Registration...\n");

    int opt;
    scanf("%d", &opt);

    if (opt > 3 || opt < 1)
    {
        printf("choose between 1-3\n\n");
    }
    else if (opt == 1)
    {
        printf("student page\n");

        printf("1. Class check\n");
        printf("2. Room check\n");

        int opts;
        scanf("%d", &opts);

        if (opts > 2 || opts < 1)
        {
            printf("choose between 1-2\n\n");
        }
        else if (opts == 1) // class check
        {
            class_check();
        }
        else if (opts == 2) // Room check
        {
            room_check();
        }
    }
    else if (opt == 2)
    {
        printf("Teacher page\n");

        printf("1. Room check\n");

        int optt;

        scanf("%d", &optt);

        if (optt == 1)
        {
            room_check();
        }
        
    }
    else if (opt == 3)
    {
        FILE *fp = fopen("student_info.txt", "r");

        if (!fp)
    {
        printf("Could not open routine file.\n");
    }
    
    }
    
    return 0;
}
